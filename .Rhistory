# Aggiungi una nuova colonna chiamata 'stagione' al tuo dataset
data <- data %>%
mutate(stagione = case_when(
between(as.numeric(mese), 3, 4) | between(as.numeric(mese), 9, 10) ~ "primavera/autunno",
between(as.numeric(mese), 5, 8) ~ "estate",
between(as.numeric(mese), 11, 12) | between(as.numeric(mese), 1, 2) ~ "inverno",
TRUE ~ NA_character_
))
data$Indice <- seq(1, dim(data)[1])
#! ---------------- Aggiungiamo le colonne ID per segnalare se ci troviamo in fase di carica o scarica per ciascuna batteria-----------------------------------
data$ID_C2  <- ifelse(data$HMI_IBatt_C2 >= 0,   1,  -1)
data$ID_C4  <- ifelse(data$HMI_IBatt_C4 >= 0,   1,  -1)
data$ID_C5  <- ifelse(data$HMI_IBatt_C5 >= 0,   1,  -1)
data$ID_C7  <- ifelse(data$HMI_IBatt_C7 >= 0,   1,  -1)
# Aggiungiamo una colonna di segnalazione quando non c'è concordanza tra le fasi di carica/scarica delle diverse batterie
data$Diversi <- ifelse(rowSums(data[, c("ID_C2", "ID_C4", "ID_C5", "ID_C7")] != data$ID_C2) > 0, 1, 0)
#! ---------------- Aggiungiamo la colonna Gruppo per ciascuna batteria --------------
# Aggiungiamo la colonna GruppiDiversi
data$GruppiDiversi <- ifelse(rowSums(data[, paste0("Gruppo_", batterie)] != data[[paste0("Gruppo_", batterie[1])]]) > 0, 1, 0)
View(data)
View(data)
View(data_POC_ID)
View(data_POC_ID)
# Aggiungiamo la colonna GruppiDiversi
data$GruppiDiversi <- ifelse(rowSums(data[, paste0("Gruppo_", batterie)] != data[[paste0("Gruppo_", batterie[1])]]) > 0, 1, 0)
# Aggiungiamo una colonna di segnalazione quando non c'è concordanza tra le fasi di carica/scarica delle diverse batterie
data$Diversi <- ifelse(rowSums(data[, c("ID_C2", "ID_C4", "ID_C5", "ID_C7")] != data$ID_C2) > 0, 1, 0)
# Aggiungiamo la colonna GruppiDiversi
data$GruppiDiversi <- ifelse(rowSums(data[, paste0("Gruppo_", batterie)] != data[[paste0("Gruppo_", batterie[1])]]) > 0, 1, 0)
##*C2
data$Derivata_C2  <- c(0, as.numeric(diff(data$HMI_IBatt_C2)) / as.numeric(diff(data$Timestamp)))
PeriodoC2         <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index]  != 1
&& (data$Derivata_C2[index] < 0
&& data$ID_C2[index] !=  data$ID_C2[index-1] )
|| PeriodoC2[index]  !=  PeriodoC2[index-1] ) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C2 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C2)
##*C4
data$Derivata_C4  <- c(0, as.numeric(diff(data$HMI_IBatt_C4)) / as.numeric(diff(data$Timestamp)))
PeriodoC4        <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if ( data$Diversi[index]  != 1
&& data$Derivata_C4[index] < 0
&& data$ID_C4[index] !=  data$ID_C4[index-1]
|| PeriodoC4[index]  !=  PeriodoC4[index-1]) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C4 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C4)
##*C5
data$Derivata_C5  <- c(0, as.numeric(diff(data$HMI_IBatt_C5)) / as.numeric(diff(data$Timestamp)))
PeriodoC5        <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index]  != 1
&& data$Derivata_C5[index] < 0
&& data$ID_C5[index]  !=  data$ID_C5[index-1]
|| PeriodoC5[index]   !=  PeriodoC5[index-1]) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C5 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C5)
##*C7
data$Derivata_C7  <- c(0, as.numeric(diff(data$HMI_IBatt_C7)) / as.numeric(diff(data$Timestamp)))
PeriodoC7       <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index]  != 1
&& data$Derivata_C7[index] < 0
&& data$ID_C7[index]      !=  data$ID_C7[index-1]
|| PeriodoC7[index] !=  PeriodoC7[index-1]) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C7 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C7)
#Aggiungiamo una colonna per controllare se i gruppi sono gli stessi per tutte le batterie
data$GruppiDiversi <- ifelse(rowSums(data[, c("Gruppo_C2", "Gruppo_C4", "Gruppo_C5", "Gruppo_C7")] != data$Gruppo_C2) > 0, 1, 0)
# osserviamo che i gruppi sono diversi
print(sum(data$GruppiDiversi))
#! ---------------- Focalizziamoci sulla Batteria C2 -----------------------------
subC2 <- data[, c("Timestamp", "Speed", "HMI_IBatt_C2", "HMI_VBatt_C2","POC_ID")]
# Colonne: ID - Derivata - Fase
subC2$ID        <- ifelse(data$HMI_IBatt_C2 >= 0,   1,  -1)
View(data)
sum(data$GruppiDiversi)
sum(data$GruppiDiversi - data$Diversi)
data$Diversi[1966]  != 1
index = 1966
data$Derivata_C2[index] < 0
##*C2
data$Derivata_C2  <- c(0, as.numeric(diff(data$HMI_IBatt_C2)) / as.numeric(diff(data$Timestamp)))
PeriodoC2         <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index]  != 1
&& (data$Derivata_C2[index] < 0
&& data$ID_C2[index] !=  data$ID_C2[index-1] )
|| PeriodoC2[index]  !=  PeriodoC2[index-1] ) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C2 <- cumsum(gruppo)
#data <- subset(data, select = -Derivata_C2)
##*C4
data$Derivata_C4  <- c(0, as.numeric(diff(data$HMI_IBatt_C4)) / as.numeric(diff(data$Timestamp)))
PeriodoC4        <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if ( data$Diversi[index]  != 1
&& data$Derivata_C4[index] < 0
&& data$ID_C4[index] !=  data$ID_C4[index-1]
|| PeriodoC4[index]  !=  PeriodoC4[index-1]) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C4 <- cumsum(gruppo)
#data <- subset(data, select = -Derivata_C4)
##*C5
data$Derivata_C5  <- c(0, as.numeric(diff(data$HMI_IBatt_C5)) / as.numeric(diff(data$Timestamp)))
PeriodoC5        <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index]  != 1
&& data$Derivata_C5[index] < 0
&& data$ID_C5[index]  !=  data$ID_C5[index-1]
|| PeriodoC5[index]   !=  PeriodoC5[index-1]) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C5 <- cumsum(gruppo)
#data <- subset(data, select = -Derivata_C5)
##*C7
data$Derivata_C7  <- c(0, as.numeric(diff(data$HMI_IBatt_C7)) / as.numeric(diff(data$Timestamp)))
PeriodoC7       <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index]  != 1
&& data$Derivata_C7[index] < 0
&& data$ID_C7[index]      !=  data$ID_C7[index-1]
|| PeriodoC7[index] !=  PeriodoC7[index-1]) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C7 <- cumsum(gruppo)
#data <- subset(data, select = -Derivata_C7)
#Aggiungiamo una colonna per controllare se i gruppi sono gli stessi per tutte le batterie
data$GruppiDiversi <- ifelse(rowSums(data[, c("Gruppo_C2", "Gruppo_C4", "Gruppo_C5", "Gruppo_C7")] != data$Gruppo_C2) > 0, 1, 0)
# osserviamo che i gruppi sono diversi
print(sum(data$GruppiDiversi))
View(data)
##*C2
data$Derivata_C2  <- c(0, as.numeric(diff(data$HMI_IBatt_C2)) / as.numeric(diff(data$Timestamp)))
PeriodoC2         <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if ((data$Derivata_C2[index] < 0
&& data$ID_C2[index] !=  data$ID_C2[index-1] )
|| PeriodoC2[index]  !=  PeriodoC2[index-1] ) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C2 <- cumsum(gruppo)
#data <- subset(data, select = -Derivata_C2)
View(data)
View(data[1000:2500,])
library(tidyverse)
library(dplyr)
library(ggplot2)
#load("my_workspace.RData")
#! ---------------- Leggiamo il Dataset e recuperiamo solo i dati del 2022 ----------------
data <- readRDS("tr_13.rds")
data_POC_ID <- readRDS("tab_tr_13_POC_ID.rds") #colonna contenente i valori di ID per ogni POC
data$POC_ID <- data_POC_ID$POC_ID
data <- subset(data, select = -POC) #eliminazione colonna POC priva di ID
data$Timestamp <- as.POSIXct(data$Timestamp) # Modifichiamo il formato di Timestamp
data  <-  data[format(data$Timestamp, "%Y") == "2022", ]
# Rinomina la colonna relativa alla velocità
names(data)[names(data) == "_VEHICLE_SPEED"] <- "Speed"
#data_ridotto <- data[1:6247,]
# Save data frame to an RDS file
#saveRDS(data_ridotto, "battery_01-03.rds")
# Visualizziamo la velocità per i primi 1000 dati
ggplot(data = data[0:1000,]) +
geom_line(mapping = aes(x = Timestamp, y = Speed))
#! ---------------- Aggiungiamo la colonna mese e la colonna stagione --------------
data <- data %>%
mutate(mese = format(Timestamp, "%m"))
# Aggiungi una nuova colonna chiamata 'stagione' al tuo dataset
data <- data %>%
mutate(stagione = case_when(
between(as.numeric(mese), 3, 4) | between(as.numeric(mese), 9, 10) ~ "primavera/autunno",
between(as.numeric(mese), 5, 8) ~ "estate",
between(as.numeric(mese), 11, 12) | between(as.numeric(mese), 1, 2) ~ "inverno",
TRUE ~ NA_character_
))
data$Indice <- seq(1, dim(data)[1])
#! ---------------- Aggiungiamo le colonne ID per segnalare se ci troviamo in fase di carica o scarica per ciascuna batteria-----------------------------------
data$ID_C2  <- ifelse(data$HMI_IBatt_C2 >= 0,   1,  -1)
data$ID_C4  <- ifelse(data$HMI_IBatt_C4 >= 0,   1,  -1)
data$ID_C5  <- ifelse(data$HMI_IBatt_C5 >= 0,   1,  -1)
data$ID_C7  <- ifelse(data$HMI_IBatt_C7 >= 0,   1,  -1)
# Aggiungiamo una colonna di segnalazione quando non c'è concordanza tra le fasi di carica/scarica delle diverse batterie
data$Diversi <- ifelse(rowSums(data[, c("ID_C2", "ID_C4", "ID_C5", "ID_C7")] != data$ID_C2) > 0, 1, 0)
#! ---------------- Aggiungiamo la colonna Gruppo per ciascuna batteria --------------
##*C2
data$Derivata_C2  <- c(0, as.numeric(diff(data$HMI_IBatt_C2)) / as.numeric(diff(data$Timestamp)))
PeriodoC2         <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if ((data$Derivata_C2[index] < 0
&& data$ID_C2[index] !=  data$ID_C2[index-1] )
|| PeriodoC2[index]  !=  PeriodoC2[index-1] ) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C2 <- cumsum(gruppo)
#data <- subset(data, select = -Derivata_C2)
##*C4
data$Derivata_C4  <- c(0, as.numeric(diff(data$HMI_IBatt_C4)) / as.numeric(diff(data$Timestamp)))
PeriodoC4        <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if ( (data$Derivata_C4[index] < 0
&& data$ID_C4[index] !=  data$ID_C4[index-1] )
|| PeriodoC4[index]  !=  PeriodoC4[index-1]) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C4 <- cumsum(gruppo)
#data <- subset(data, select = -Derivata_C4)
##*C5
data$Derivata_C5  <- c(0, as.numeric(diff(data$HMI_IBatt_C5)) / as.numeric(diff(data$Timestamp)))
PeriodoC5        <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if ( ( data$Derivata_C5[index] < 0
&& data$ID_C5[index]  !=  data$ID_C5[index-1] )
|| PeriodoC5[index]   !=  PeriodoC5[index-1]) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C5 <- cumsum(gruppo)
#data <- subset(data, select = -Derivata_C5)
##*C7
data$Derivata_C7  <- c(0, as.numeric(diff(data$HMI_IBatt_C7)) / as.numeric(diff(data$Timestamp)))
PeriodoC7       <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (( data$Derivata_C7[index] < 0
&& data$ID_C7[index]      !=  data$ID_C7[index-1] )
|| PeriodoC7[index] !=  PeriodoC7[index-1]) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C7 <- cumsum(gruppo)
#data <- subset(data, select = -Derivata_C7)
View(data)
View(data[1000:2500,])
#Aggiungiamo una colonna per controllare se i gruppi sono gli stessi per tutte le batterie
data$GruppiDiversi <- ifelse(rowSums(data[, c("Gruppo_C2", "Gruppo_C4", "Gruppo_C5", "Gruppo_C7")] != data$Gruppo_C2) > 0, 1, 0)
View(data)
View(data[1000:2500,])
# osserviamo che i gruppi sono diversi
print(sum(data$GruppiDiversi))
# osserviamo che i gruppi sono diversi
print(sum(data$GruppiDiversi))
which.min(abs(data$Gruppo_C2 - data$Gruppo_C4) == 1 )
which.max(abs(data$Gruppo_C2 - data$Gruppo_C4) == 1 )
library(tidyverse)
library(dplyr)
library(ggplot2)
#load("my_workspace.RData")
#! ---------------- Leggiamo il Dataset e recuperiamo solo i dati del 2022 ----------------
data <- readRDS("tr_13.rds")
data_POC_ID <- readRDS("tab_tr_13_POC_ID.rds") #colonna contenente i valori di ID per ogni POC
data$POC_ID <- data_POC_ID$POC_ID
data <- subset(data, select = -POC) #eliminazione colonna POC priva di ID
data$Timestamp <- as.POSIXct(data$Timestamp) # Modifichiamo il formato di Timestamp
data  <-  data[format(data$Timestamp, "%Y") == "2022", ]
# Rinomina la colonna relativa alla velocità
names(data)[names(data) == "_VEHICLE_SPEED"] <- "Speed"
data$Indice <- seq(1, dim(data)[1])
#! ---------------- Aggiungiamo le colonne ID per segnalare se ci troviamo in fase di carica o scarica per ciascuna batteria-----------------------------------
data$ID_C2  <- ifelse(data$HMI_IBatt_C2 >= 0,   1,  -1)
data$ID_C4  <- ifelse(data$HMI_IBatt_C4 >= 0,   1,  -1)
data$ID_C5  <- ifelse(data$HMI_IBatt_C5 >= 0,   1,  -1)
data$ID_C7  <- ifelse(data$HMI_IBatt_C7 >= 0,   1,  -1)
# Aggiungiamo una colonna di segnalazione quando non c'è concordanza tra le fasi di carica/scarica delle diverse batterie
data$Diversi <- ifelse(rowSums(data[, c("ID_C2", "ID_C4", "ID_C5", "ID_C7")] != data$ID_C2) > 0, 1, 0)
#! ---------------- Aggiungiamo la colonna Gruppo per ciascuna batteria --------------
##*C2
data$Derivata_C2  <- c(0, as.numeric(diff(data$HMI_IBatt_C2)) / as.numeric(diff(data$Timestamp)))
PeriodoC2         <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index] != 1
&& ((data$Derivata_C2[index] < 0 && data$ID_C2[index] != data$ID_C2[index-1]) || PeriodoC2[index] != PeriodoC2[index-1])) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C2 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C2)
##*C4
data$Derivata_C4  <- c(0, as.numeric(diff(data$HMI_IBatt_C4)) / as.numeric(diff(data$Timestamp)))
PeriodoC4         <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index] != 1
&& ((data$Derivata_C4[index] < 0 && data$ID_C4[index] != data$ID_C4[index-1]) || PeriodoC4[index] != PeriodoC4[index-1])) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C4 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C4)
##*C5
data$Derivata_C5  <- c(0, as.numeric(diff(data$HMI_IBatt_C5)) / as.numeric(diff(data$Timestamp)))
PeriodoC5        <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index] != 1
&& ((data$Derivata_C5[index] < 0 && data$ID_C5[index] != data$ID_C5[index-1]) || PeriodoC5[index] != PeriodoC5[index-1])) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C5 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C5)
##*C7
data$Derivata_C7  <- c(0, as.numeric(diff(data$HMI_IBatt_C7)) / as.numeric(diff(data$Timestamp)))
PeriodoC7       <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index] != 1
&& ((data$Derivata_C7[index] < 0 && data$ID_C7[index] != data$ID_C7[index-1]) || PeriodoC7[index] != PeriodoC7[index-1])) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C7 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C7)
View(data)
data[5,]
for (index in 2:(length(data$Timestamp){
for (index in 2:(length(data$Timestamp) {
for (index in 2:(length(data$Timestamp)) {
for (index in 2:(length(data$Timestamp))) {
if(data$Diversi[index] == 1) {
data[index,] <- c(data$Timestamp[index],  data[index-1, -1])
}
}
for (index in 2:(length(data$Timestamp))) {
if(data$Diversi[index] == 1) {
data[index,] <- c(data$Timestamp[index],  data[(index-1), -1])
}
}
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index] == 1) {
temp_row <- c(data$Timestamp[index], data[(index - 1), -1])
data[index, ] <- as.data.frame(t(temp_row))
}
}
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index] == 1) {
data[index, -1] <- data[(index - 1), -1]
}
}
View(data)
#! ---------------- Aggiungiamo la colonna Gruppo per ciascuna batteria --------------
##*C2
data$Derivata_C2  <- c(0, as.numeric(diff(data$HMI_IBatt_C2)) / as.numeric(diff(data$Timestamp)))
PeriodoC2         <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index] != 1
&& ((data$Derivata_C2[index] < 0 && data$ID_C2[index] != data$ID_C2[index-1]) || PeriodoC2[index] != PeriodoC2[index-1])) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C2 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C2)
##*C4
data$Derivata_C4  <- c(0, as.numeric(diff(data$HMI_IBatt_C4)) / as.numeric(diff(data$Timestamp)))
PeriodoC4         <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index] != 1
&& ((data$Derivata_C4[index] < 0 && data$ID_C4[index] != data$ID_C4[index-1]) || PeriodoC4[index] != PeriodoC4[index-1])) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C4 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C4)
##*C5
data$Derivata_C5  <- c(0, as.numeric(diff(data$HMI_IBatt_C5)) / as.numeric(diff(data$Timestamp)))
PeriodoC5        <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index] != 1
&& ((data$Derivata_C5[index] < 0 && data$ID_C5[index] != data$ID_C5[index-1]) || PeriodoC5[index] != PeriodoC5[index-1])) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C5 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C5)
##*C7
data$Derivata_C7  <- c(0, as.numeric(diff(data$HMI_IBatt_C7)) / as.numeric(diff(data$Timestamp)))
PeriodoC7       <- cumsum(c(0, diff(data$Timestamp) > 15))
#* Contatore Gruppi
gruppo <- rep(0, length(data$Timestamp))
for (index in 2:(length(data$Timestamp))) {
if (data$Diversi[index] != 1
&& ((data$Derivata_C7[index] < 0 && data$ID_C7[index] != data$ID_C7[index-1]) || PeriodoC7[index] != PeriodoC7[index-1])) {
gruppo[index] <-  1
}
else {
gruppo[index] <-  0
}
}
data$Gruppo_C7 <- cumsum(gruppo)
data <- subset(data, select = -Derivata_C7)
View(data)
#Aggiungiamo una colonna per controllare se i gruppi sono gli stessi per tutte le batterie
data$GruppiDiversi <- ifelse(rowSums(data[, c("Gruppo_C2", "Gruppo_C4", "Gruppo_C5", "Gruppo_C7")] != data$Gruppo_C2) > 0, 1, 0)
View(data)
